<div align="center">
 <h1>
  <img src="https://raw.githubusercontent.com/devicons/devicon/master/icons/nodejs/nodejs-original.svg" alt="node" width=80/> +
  <img src="https://raw.githubusercontent.com/devicons/devicon/master/icons/sequelize/sequelize-original.svg" alt="sequelize" width=80/> +
 <img src="https://raw.githubusercontent.com/devicons/devicon/master/icons/postgresql/postgresql-original.svg" alt="postgres" width=80/>
 </h1>
</div>

---

# Criando uma API com Sequelize
 [‚ûú Conceitos iniciais](#conceitos-iniciais)<br>
 [‚ûú Iniciando a aplica√ß√£o](#iniciando-a-aplica√ß√£o)<br>
 [‚ûú Configura√ß√£o e cria√ß√£o da database](#configura√ß√£o-e-cria√ß√£o-da-database)<br>
 [‚ûú Criando tabelas usando migrations](#criando-tabelas-usando-migrations)<br>
 [‚ûú Registrando dados no banco](#registrando-dados-no-banco)


## Conceitos iniciais
<sup>[Voltar ao topo](#criando-uma-api-com-sequelize)</sup><br>
- **Migrations**: Representam o "hist√≥rico" de altera√ß√µes do banco de dados; a maneira como ele vai se comportar em tempo de aplica√ß√£o.
- **MVC**: Sigla para o padr√£o *Model View Controller*.
- **Model**: Define o modo como vai ser a comunica√ß√£o com o banco de dados.

---

## Iniciando a aplica√ß√£o
<sup>[Voltar ao topo](#criando-uma-api-com-sequelize)</sup><br>
**Criando a pasta onde ficar√° o c√≥digo**
```bash
mkdir slqnode
cd slqnode
```
```javascript
yarn init -y
```
*Obs*: A flag `y` indica que queremos pular a sess√£o interativa e gera um `‚Äépackage.json` baseado no seu padr√µes

### Instalando as bibliotecas
- express (Framework)
- pg (postgres)
- ph-hstore (postgres)
- sequelize (ORM)
- sequelize-cli (depend. de desenvolvimento)
- nodemon (depend. de desenvolvimento) (reinicia a aplica√ß√£o a cada altera√ß√£o)

### Criando os arquivos iniciais
No package.json:
```javascript
"scripts": {
    "dev": "nodemon src/server.js"
  },
```

Criando a pasta `src` e nela o arquivos `server.js` e `routes.js`:

**server.js**
```javascript
const express = require('express');
const routes = require('./routes');

const app = express();

app.use(express.json()); // Permitir que nossa API saiba lidar com requisi√ß√µes JSON

app.use(routes);

app.listen(3333); //Porta onde o servidor ir√° rodar.
```
**routes.js**
```javascript
const express = require('express');

const routes = express.Router();


routes.get('/', (req, res) => {
  return res.json({ hello: 'world' });
});

module.exports = routes;
```

Rodando `yarn dev` no terminal e acessando a porta, j√° √© poss√≠vel ver nossa aplica√ß√£o funcionando:
```javascript
//http://localhost:3333

{
  "hello": "world"
}
```
---

## Configura√ß√£o e cria√ß√£o da database
<sup>[Voltar ao topo](#criando-uma-api-com-sequelize)</sup><br>
Na pasta `database`:<br/>
**`index.js`**: onde ser√° feita a conex√£o com o banco de dados.

Na pasta `src`:<br/>
**`config/database.js`**: armazena as credenciais de acesso ao banco de dados.

**`database.js`**: ir√° exportar um objeto de configura√ß√µes
```javascript
module.exports = {
  dialect: 'postgres',
  host: 'localhost',
  username: 'postgres',
  password: 'admin',
  database: 'sqlnode',
  define: {
    // Indica que toda tabela do meu banco ter√° os campos: created_at e updated_at
    timestamps: true,

    // Far√° uso do snake_case para nomear as tabelas
    // Obs: por padr√£o o Sequelize utiliza o Pascal Case
    underscored: true, 
  },
}
```

Por padr√£o, o Sequelize ir√° buscar o arquivo `config/config.json` para obter as configura√ß√µes do banco de dados. Por isso vamos configurar o Sequelize para que ele busque as configura√ß√µes no arquivo `config/database.js`:

Na pasta raiz do projeto criaremos o arquivo `.sequelizerc`:
```javascript
const path = require('path');

module.exports = {
  config: path.resolve(__dirname, 'src', 'config', 'database.js');
};
```
  
### Criando a conex√£o com o banco de dados
No arquivo `database/index.js`:
```javascript
const Sequelize = require('sequelize');
const dbConfig = require('../config/database');

//Conex√£o com o banco de dados
const connection = new Sequelize(dbConfig);

module.exports = connection;
```

### Criando o banco
No terminal:
```bash
yarn sequelize db:create
```

Existem alguns programas que permite visualizar o banco e suas tabelas como:
- [Beekeeper Studio](https://www.beekeeperstudio.io/)
- [Postico](https://eggerapps.at/postico/)
- [DBeaver](https://dbeaver.io/)
---
## Criando tabelas usando migrations
<sup>[Voltar ao topo](#criando-uma-api-com-sequelize)</sup><br>
De volta ao `.sequelizerc`, precisamos informar ao Sequelize onde ser√£o mantidas as migrations da aplica√ß√£o:
```javascript
const path = require('path');

module.exports = {
  config: path.resolve(__dirname, 'src', 'config', 'database.js'),
  'migrations-path': path.resolve(__dirname, 'src', 'database', 'migrations')
};

```
N√£o esque√ßa de criar a pasta `migrations` no local informado nas configura√ß√µes.

### Criando a primeira migration
Nossa primeira tabela ser√° a de usu√°rios, para isso criaremos a migration respons√°vel por cria-l√°, bem como seus campos.

No terminal:
```bash
yarn sequelize migration:create --name=create-users
```

Na pasta `migrations` voc√™ encontrar√° algo semelhante a isso:
```
üìÅ migrations
‚ûú üü® 20191016131653-create-users.js
```
Esses n√∫meros s√£o o timestamp de quando a migration foi criada. Com isso vai sendo montado o hist√≥rico do seu banco de dados. As migrations s√£o executadas de forma linear.

#### Estrutura da migration
Ao entrar no arquivo rec√©m-criado voc√™ encontrar√° um objeto sendo exportado com dois m√©todos: **up** e **down**.
```javascript
'use-strict';

module.exports = {
  up: (queryInterface, Sequelize) => {
    //Esse m√©todo representa o que essa migration ir√° fazer no banco de dados.
    //Ex: criar a tabela users
  },

  down:(queryInterface, Sequelize) => {
    //Se houver algum erro ao realizar o m√©todo "up", esse m√©todo ir√° desfazer as altera√ß√µes feitas no banco de dados.
    //Ex: excluir a tabela users
  }
}
```

### Configurando uma tabela
Ainda no arquivo da migration, iremos fazer as configura√ß√µes da nossa tabela, como os campos que ela ter√° e as configura√ß√µes desses campos.

```javascript
up: async (queryInterface, Sequelize) => {
    return await queryInterface.createTable('users', {
      id: {
        type: Sequelize.INTEGER,
        primaryKey: true, 
        autoIncrement: true,
        allowNull: false,
      },
      name: {
        type: Sequelize.STRING,
        allowNull: false,
      },
      email: {
        type: Sequelize.STRING,
        allowNull: false,
      },

      //Apesar desses campos serem preenchidos de forma autom√°tica,
      //eles precisam ser informados na cria√ß√£o da tabela.
      created_at: {
        type: Sequelize.DATE,
        allowNull: false,
      },
      updated_at: {
        type: Sequelize.DATE,
        allowNull: false,
      }
    });
  },
```
### Criando a tabela no banco de dados
Para a tabela ser criada de fato na base de dados, usaremos o seguinte comando no terminal:
```bash
yarn sequelize db:migrate
```
Isso far√° com que todas as migrations do nosso projeto sejam executadas.

#### SequelizeMeta
Al√©m das nossas tabelas, haver√° tamb√©m a tabela SequelizeMeta, que ir√° armazenar o hist√≥rico de migrations do nosso banco.

### Corringindo erros e desfazendo migrations
Caso perceba que cometeu um erro, como o nome errado de um campo, voc√™ pode desfazer as migrations:
```bash
yarn sequelize db:migrate:undo
```
Depois s√≥ corrigir o erro e executar o comando de migrations novamente.

No entanto, caso sua aplica√ß√£o j√° esteja em produ√ß√£o voc√™ n√£o poder√° voltar atr√°s. A melhor forma de contornar o erro √© criando um nova migration respons√°vel por isso.

---

## Registrando dados no banco
<sup>[Voltar ao topo](#criando-uma-api-com-sequelize)</sup><br>
### Models
Um model √© a representa√ß√£o de como nossa aplica√ß√£o vai se comunicar com a nossa base dados

### Criando model de Usu√°rio
```
üìÅ models
‚ûú üü® User.js
```

Os models s√£o representados atrav√©s de classes. Essas classes extendem as propriedades da classe Model proveniente do Sequelize.

```javascript
const { Model } = require('sequelize');

class User extends Model {

}

module.exports = User;
```

#### Configurando o model
- M√©todo `init()`: vai receber a conex√£o com  a base de dados e os campos da tabela que estamos referenciando.
```javascript
static init(sequelize) {
  super.init({ //Chama o m√©todo init() da classe Model.
    name: DataTypes.STRING, //Importar o DataTypes do Sequelize
    email: DataTypes.STRING,
  }, {
    sequelize //conex√£o com o banco
  })
}
```
Obs: N√£o √© necess√°rio informar as colunas de id e timestamps.

### Iniciando o model para realizar a conex√£o
No arquivo `database/index.js`:
```javascript
const User = require('../models/User');
User.init(connection);
```
### Criando uma rota de cadastro (POST)
No arquivo `routes.js`:
```javascript
const UserController =  require('./controllers/UserController');
routes.post('/users', UserController.store);
```
A fun√ß√£o de cria√ß√£o de users `UserController.store` ser√° definida no arquivo `UserController.js`.
Para isso criaremos uma pasta `controllers` em `src`:
```
üìÅ controllers
‚ûú üü® UserController.js
```

Nos controllers que definiremos as fun√ß√µes que ser√£o chamadas nas rotas, que podem ser dos tipos: GET, POST, PUT e DELETE..

S√£o os controllers que lidam com as requisi√ß√µes e respostas do servidor.

#### Definindo a fun√ß√£o `UserController.store`:
Para isso usaremos nosso model User.
```javascript
module.exports = {
  async  store(req, res) {
    const { name, email } =  req.body;
    const  user  =  await  User.create({name, email});
    return  res.json(user);
  }
}
```

#### Outras fun√ß√µes
Tamb√©m √© poss√≠vel criar outras fun√ß√µes, como listar os usu√°rios (GET), editar seus dados (PUT) ou delet√°-lo (DELETE).
Ex: Listagem de usu√°rios `UserController.index`:
```javascript
module.exports = {
  async  index(req, res) {
    const  users  =  await  User.findAll();
   return  res.json(users);
  },
  // outras fun√ß√µes
}
```

### Importando as conex√µes com o banco
Tamb√©m √© necess√°rio importar as conex√µes com o banco, que est√£o no arquivo `database/index.js` dentro do arquivo `server.js`:
```javascript
const  express  =  require('express');
const  routes  =  require('./routes');

require('./database'); // Importando as conex√µes

const  app  =  express();

app.use(express.json());
app.use(routes);

app.listen(3333);
```
